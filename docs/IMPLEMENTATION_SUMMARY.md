# λΉκ²μ΄νΈ PG μ—°λ™ κµ¬ν„ ν„ν™© μ”μ•½

## π― ν„μ¬ κµ¬ν„ μ™„λ£ μ‚¬ν•­

### β… 1. CHECK_SUM μƒμ„± μ‹μ¤ν… (μ™„λ£)
- **νμΌ**: `lib/billgate/checksum.ts`
- **κΈ°λ¥**: λΉκ²μ΄νΈ κ²°μ  μ”μ²­ μ‹ λ°μ΄ν„° μ„λ³€μ΅° λ°©μ§€λ¥Ό μ„ν• μ²΄ν¬μ„¬ μƒμ„±
- **ν…μ¤νΈ**: β… μ •μƒ μ‘λ™ ν™•μΈ (40μλ¦¬ CHECK_SUM μƒμ„±)

### β… 2. κ²°μ  μ¤€λΉ„ API (μ™„λ£)
- **νμΌ**: `app/api/payment/prepare/route.ts`
- **κΈ°λ¥**: 
  - CHECK_SUM μƒμ„±
  - λΉκ²μ΄νΈ κ²°μ μ°½ νΈμ¶μ— ν•„μ”ν• λ¨λ“  νλΌλ―Έν„° μ κ³µ
  - μ£Όλ¬Έ λ‚ μ§/μ‹κ°„ μλ™ μƒμ„± (YYYYMMDDHHMMSS ν•μ‹)

### β… 3. κµ¬λ§¤ νμ΄μ§€ μμ • (μ™„λ£)
- **νμΌ**: `app/purchase/page.tsx`
- **λ³€κ²½μ‚¬ν•­**:
  - κΈ°μ΅΄ μ§μ ‘ μ£Όλ¬Έ μƒμ„± β†’ λΉκ²μ΄νΈ κ²°μ μ°½ νΈμ¶
  - localStorageλ¥Ό ν†µν• μ£Όλ¬Έ μ •λ³΄ μ„μ‹ μ €μ¥
  - λ™μ  Form μƒμ„±μΌλ΅ λΉκ²μ΄νΈ κ²°μ μ°½ POST μ”μ²­

### β… 4. κ²°μ  μ™„λ£ μ²λ¦¬ νμ΄μ§€ (μ™„λ£)
- **νμΌ**: `app/payment/return/page.tsx`
- **κΈ°λ¥**:
  - λΉκ²μ΄νΈ κ²°μ μ°½μ—μ„ λ¦¬ν„΄λλ” λ°μ΄ν„° μ²λ¦¬
  - κ²°μ  μ„±κ³µ/μ‹¤ν¨ μƒνƒ ν‘μ‹
  - μλ™μΌλ΅ μ™„λ£ νμ΄μ§€λ΅ λ¦¬λ””λ ‰μ…

---

## π― **μ™„μ „ κµ¬ν„ μ™„λ£λ κΈ°λ¥λ“¤** β…

### β… 1. SEED μ•”νΈν™” μ‹μ¤ν… (100% μ™„λ£) π”
- **νμΌ**: `lib/billgate/seed-encryption.ts` β… **κµ¬ν„ μ™„λ£**
- **λΌμ΄λΈλ¬λ¦¬**: `lib/korea-forge-jclab-main/` β… **μ„¤μΉ μ™„λ£**
- **κΈ°λ¥**:
  - SEED-CBC μ•”νΈν™”/λ³µνΈν™” μ™„μ „ κµ¬ν„
  - λΉκ²μ΄νΈ λ©”μ‹μ§€ μƒμ„±/νμ‹± κΈ°λ¥
  - ν…μ¤νΈ ν•¨μ ν¬ν•¨
- **μ„¤μ •**:
  - μ•”νΈν™” ν‚¤: Base64 λ””μ½”λ”© ν›„ μ‚¬μ©
  - IV: `PRJ59Q2GHPT844TQ` (16λ°”μ΄νΈ)
- **ν…μ¤νΈ**: β… **μ™„λ£** - ν•κΈ€, μλ¬Έ, μ«μ λ¨λ“  λ°μ΄ν„° μ •μƒ μ²λ¦¬ ν™•μΈ

### β… 2. Socket ν†µμ‹  μ„λΉ„μ¤ (100% μ™„λ£) π
- **νμΌ**: `lib/billgate/socket-service.ts` β… **μ‹ κ· κµ¬ν„ μ™„λ£**
- **κΈ°λ¥**:
  - λΉκ²μ΄νΈ μ„λ²„μ™€ Socket ν†µμ‹  (`tapi.billgate.net:30900`)
  - μΉμΈ/μ·¨μ† μ”μ²­μ„ μ„ν• μ•”νΈν™”λ ν†µμ‹ 
  - νƒ€μ„μ•„μ›ƒ λ° μ—λ¬ μ²λ¦¬ μ™„λΉ„
  - `BillgateSocketService` ν΄λμ¤λ΅ κµ¬μ΅°ν™”
- **ν…μ¤νΈ**: β… **μ—°κ²° ν…μ¤νΈ κΈ°λ¥ ν¬ν•¨**

### β… 3. κ²°μ  μΉμΈ API (100% μ™„λ£) π’³
- **νμΌ**: `app/api/payment/approve/route.ts` β… **μ‹ κ· κµ¬ν„ μ™„λ£**
- **κΈ°λ¥**:
  - λΉκ²μ΄νΈ κ²°μ μ°½μ—μ„ λ¦¬ν„΄λ λ°μ΄ν„° μ²λ¦¬
  - Socket ν†µμ‹ μΌλ΅ λΉκ²μ΄νΈ μ„λ²„μ— μΉμΈ μ”μ²­
  - Supabase μ£Όλ¬Έ μ •λ³΄ μ—…λ°μ΄νΈ
  - QRμ½”λ“ μƒμ„± λ° Storage μ—…λ΅λ“
  - κ²°μ  μƒνƒ μ΅°ν κΈ°λ¥ (GET)

### β… 4. κ²°μ  μ·¨μ† API (100% μ™„λ£) π”„
- **νμΌ**: `app/api/payment/cancel/route.ts` β… **μ‹ κ· κµ¬ν„ μ™„λ£**
- **κΈ°λ¥**:
  - Socket ν†µμ‹ μΌλ΅ λΉκ²μ΄νΈ μ„λ²„μ— μ·¨μ† μ”μ²­
  - λ¶€λ¶„ μ·¨μ† λ° μ „μ²΄ μ·¨μ† μ§€μ›
  - μ·¨μ† κ°€λ¥ν• μ£Όλ¬Έ λ©λ΅ μ΅°ν (GET)
  - Supabase μ£Όλ¬Έ μƒνƒ μ—…λ°μ΄νΈ

---

## π“‹ ν…μ¤νΈ μ‹λ‚λ¦¬μ¤

### ν„μ¬ ν…μ¤νΈ κ°€λ¥ν• λ¶€λ¶„
1. β… CHECK_SUM μƒμ„± API: `/api/payment/prepare`
2. β… κµ¬λ§¤ νμ΄μ§€μ—μ„ λΉκ²μ΄νΈ κ²°μ μ°½ νΈμ¶
3. β… κ²°μ  μ™„λ£ ν›„ λ¦¬ν„΄ URL μ²λ¦¬

### μ™„μ „ν• ν…μ¤νΈλ¥Ό μ„ν•΄ ν•„μ”ν• κ²ƒ
1. **SEED μ•”νΈν™” κµ¬ν„** β†’ λΉκ²μ΄νΈ μ„λ²„μ™€ μ‹¤μ  ν†µμ‹  κ°€λ¥
2. **Socket ν†µμ‹  κµ¬ν„** β†’ κ²°μ  μΉμΈ/μ·¨μ† μ²λ¦¬ κ°€λ¥

---

## π€ μ¦‰μ‹ μ‹¤ν–‰ κ°€λ¥ν• λ‹¤μ λ‹¨κ³„

### Step 1: SEED μ•”νΈν™” λΌμ΄λΈλ¬λ¦¬ μ„¤μΉ λ° ν…μ¤νΈ
```bash
npm install git+https://github.com/jc-lab/korea-forge.git
```

### Step 2: κΈ°λ³Έ SEED μ•”νΈν™” κµ¬ν„
```typescript
// lib/billgate/seed-crypto.ts
import { SEED } from 'korea-forge';

export class SeedCrypto {
  encrypt(plaintext: string, key: Buffer, iv: string): string {
    // SEED-CBC μ•”νΈν™” κµ¬ν„
  }
  
  decrypt(ciphertext: string, key: Buffer, iv: string): string {
    // SEED-CBC λ³µνΈν™” κµ¬ν„
  }
}
```

### Step 3: Socket ν†µμ‹  κΈ°λ³Έ κµ¬μ΅° κµ¬ν„
```typescript
// lib/billgate/socket.ts
import * as net from 'net';

export class BillgateSocket {
  async sendApprovalRequest(message: string): Promise<any> {
    // λΉκ²μ΄νΈ μ„λ²„μ™€ Socket ν†µμ‹ 
  }
}
```

---

## π― ν„μ¬ ν”„λ΅μ νΈ μƒνƒ

### μ‘λ™ν•λ” κΈ°λ¥
- β… κ²°μ  μ¤€λΉ„ (CHECK_SUM μƒμ„±)
- β… λΉκ²μ΄νΈ κ²°μ μ°½ νΈμ¶
- β… κ²°μ  μ™„λ£ ν›„ λ¦¬ν„΄ μ²λ¦¬ (UIλ§)

### μ‘λ™ν•μ§€ μ•λ” κΈ°λ¥
- β μ‹¤μ  λΉκ²μ΄νΈ μ„λ²„μ™€ ν†µμ‹  (SEED μ•”νΈν™” ν•„μ”)
- β κ²°μ  μΉμΈ μ²λ¦¬ (Socket ν†µμ‹  ν•„μ”)
- β κ²°μ  μ·¨μ† κΈ°λ¥

---

## π“ μ„¤μ • ν•„μ”μ‚¬ν•­

### ν™κ²½ λ³€μ (.env.local)
```env
# λΉκ²μ΄νΈ PG μ„¤μ •
BILLGATE_SERVICE_ID=M2103135
BILLGATE_API_HOST=tapi.billgate.net
BILLGATE_API_PORT=30900
BILLGATE_ENCRYPTION_KEY=QkZJRlBDRTI4T0c1OUtBMw==
BILLGATE_ENCRYPTION_IV=PRJ59Q2GHPT844TQ
BILLGATE_MODE=0

# Next.js μ„¤μ •
NEXT_PUBLIC_BASE_URL=http://localhost:3000
```

---

---

## π§ **ν…μ¤νΈ μ™„λ£ μ‚¬ν•­**

### β… ν†µν•© ν…μ¤νΈ μ¤ν¬λ¦½νΈ (μ™„λ£)
- **νμΌ**: `test-billgate-complete.js` β… **μƒμ„± μ™„λ£**
- **ν…μ¤νΈ ν•­λ©**:
  - CHECK_SUM μƒμ„±/κ²€μ¦
  - SEED μ•”νΈν™”/λ³µνΈν™”
  - Socket μ—°κ²° ν…μ¤νΈ
  - κ²°μ  μ¤€λΉ„ API ν…μ¤νΈ
  - λΉκ²μ΄νΈ λ©”μ‹μ§€ μ²λ¦¬ ν…μ¤νΈ

### β… ν™κ²½ μ„¤μ • κ°€μ΄λ“ (μ™„λ£)
- **νμΌ**: `docs/ENVIRONMENT_SETUP.md` β… **μƒμ„± μ™„λ£**
- **λ‚΄μ©**:
  - ν™κ²½ λ³€μ μ„¤μ • λ°©λ²•
  - Supabase ν…μ΄λΈ” μ¤ν‚¤λ§
  - ν…μ¤νΈ λ°©λ²• λ° μΉ΄λ“ μ •λ³΄
  - λ¬Έμ  ν•΄κ²° κ°€μ΄λ“
  - μ΄μ ν™κ²½ μ „ν™ κ°€μ΄λ“

---

## π‰ **κ²°λ΅ **

**ν„μ¬ μƒνƒ**: λΉκ²μ΄νΈ PG μ—°λ™μ λ¨λ“  ν•µμ‹¬ κΈ°λ¥μ΄ μ™„μ „ν κµ¬ν„λμ—μµλ‹λ‹¤! β…

**κµ¬ν„λ νμΌλ“¤**:
- β… `lib/billgate/checksum.ts` - CHECK_SUM μƒμ„±
- β… `lib/billgate/seed-encryption.ts` - SEED μ•”νΈν™”
- β… `lib/billgate/socket-service.ts` - Socket ν†µμ‹ 
- β… `app/api/payment/prepare/route.ts` - κ²°μ  μ¤€λΉ„
- β… `app/api/payment/approve/route.ts` - κ²°μ  μΉμΈ
- β… `app/api/payment/cancel/route.ts` - κ²°μ  μ·¨μ†
- β… `app/purchase/page.tsx` - κµ¬λ§¤ νμ΄μ§€ (μμ •)
- β… `app/payment/return/page.tsx` - κ²°μ  μ™„λ£ νμ΄μ§€ (μμ •)
- β… `test-billgate-complete.js` - ν†µν•© ν…μ¤νΈ
- β… `docs/ENVIRONMENT_SETUP.md` - ν™κ²½ μ„¤μ • κ°€μ΄λ“

**μ¦‰μ‹ μ‹¤ν–‰ κ°€λ¥**: ν™κ²½ λ³€μ μ„¤μ • ν›„ λ°”λ΅ μ‹¤μ  κ²°μ  ν…μ¤νΈ κ°€λ¥! π€ 